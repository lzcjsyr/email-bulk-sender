# 捐赠证书邮件群发

专用于批量发送捐赠证书的邮件工具，可自动从证书文件名提取收件人信息并发送个性化感谢邮件。

---

## 📋 功能特性

- 从证书文件名自动提取收件人信息（姓名和邮箱）
- 自动发送个性化感谢邮件
- 证书图片作为附件发送
- 生成 Excel 确认表供人工核对
- 支持中文文件名和邮箱地址

---

## 🚀 使用说明

### 前提条件

1. 已完成根目录的环境配置（运行过 `setup.sh` 或 `setup.bat`）
2. 已配置好 `.env` 文件中的邮箱信息

如果还没有完成，请先查看[根目录 README](../README.md) 完成环境配置。

---

## 📖 操作步骤

### 步骤1：准备证书文件

将证书图片放入 `捐赠证书/` 文件夹

**文件命名格式**：`姓名_邮箱.jpg`

**示例**：
- `张三_zhang@example.com.jpg`
- `李四_li@company.com.jpg`
- `王五_wangwu@gmail.com.jpg`

**支持的文件格式**：
- `.jpg` / `.jpeg`
- `.png`
- `.pdf`（如果证书是 PDF 格式）

### 步骤2：解析证书文件名

运行解析脚本，从文件名中提取姓名和邮箱信息：

```bash
# 激活虚拟环境（如果还没激活）
source ../email_venv/bin/activate          # macOS/Linux
..\email_venv\Scripts\activate.bat         # Windows

# 运行解析脚本
python parse_certificates.py
```

脚本会：
1. 扫描 `捐赠证书/` 文件夹中的所有文件
2. 从文件名中提取姓名和邮箱
3. 生成 `证书信息确认表.xlsx` Excel 文件

### 步骤3：核对确认表

打开生成的 `证书信息确认表.xlsx`，检查：

| 姓名 | 邮箱 | 证书文件名 |
|------|------|-----------|
| 张三 | zhang@example.com | 张三_zhang@example.com.jpg |
| 李四 | li@company.com | 李四_li@company.com.jpg |

确认以下信息：
- ✅ 姓名是否正确
- ✅ 邮箱地址是否正确
- ✅ 证书文件名是否完整

**如果有错误**：
1. 修正原始证书文件的文件名
2. 重新运行 `parse_certificates.py`

### 步骤4：发送证书邮件

确认信息无误后，运行发送脚本：

```bash
python send_certificates.py
```

脚本会：
1. 读取 `证书信息确认表.xlsx`
2. 逐个发送带有证书附件的感谢邮件
3. 在命令行显示发送进度
4. 报告成功和失败的情况

---

## 📁 文件结构

```
捐赠证书群发_临时/
├── README.md                  # 本文档
├── parse_certificates.py      # 解析证书文件名脚本
├── send_certificates.py       # 发送证书邮件脚本
├── 捐赠证书/                  # 证书文件夹（放置证书图片）
│   ├── 张三_zhang@example.com.jpg
│   ├── 李四_li@company.com.jpg
│   └── ...
└── 证书信息确认表.xlsx        # 自动生成的确认表
```

---

## ⚙️ 自定义邮件模板

邮件模板硬编码在 `send_certificates.py` 中，如需自定义，请编辑该文件中的邮件内容。

找到以下部分并修改：

```python
# 邮件主题
subject = f"感谢您的捐赠 - {recipient_name}"

# 邮件正文
body = f"""尊敬的 {recipient_name}：

您好！

感谢您的慷慨捐赠！

附件是您的捐赠证书，请查收。

再次感谢您的支持！

此致
敬礼

XXX 基金会
"""
```

**可用变量**：
- `{recipient_name}` - 收件人姓名（从文件名提取）

---

## 🔧 常见问题

### 1. 文件名格式不正确

**错误示例**：
- `张三.jpg` ❌（缺少邮箱）
- `zhang@example.com.jpg` ❌（缺少姓名）
- `张三-zhang@example.com.jpg` ❌（使用了 `-` 而非 `_`）

**正确示例**：
- `张三_zhang@example.com.jpg` ✅

### 2. 解析脚本找不到文件

确保：
- 证书文件放在 `捐赠证书/` 文件夹中
- 文件夹名称正确（区分简体/繁体）
- 文件有读取权限

### 3. 邮件发送失败

检查：
- 根目录的 `.env` 配置是否正确
- 网络连接是否正常
- 邮箱 SMTP 服务是否开启
- 附件大小是否超过限制（建议 < 5MB）

### 4. 中文文件名乱码

- macOS/Linux：通常无问题
- Windows：确保终端编码为 UTF-8
  ```cmd
  chcp 65001
  ```

---

## ⚠️ 注意事项

### 发送前检查

1. ✅ 先用 1-2 个测试邮箱测试
2. ✅ 检查邮件内容和格式
3. ✅ 确认证书附件正确
4. ✅ 核对所有收件人信息

### 发送建议

1. **批量发送控制**
   - 如果收件人很多，建议分批发送
   - 可以在 Excel 中先删除部分行，分多次运行

2. **发送间隔**
   - 脚本默认每封邮件间隔 2-3 秒
   - 如需调整，修改 `send_certificates.py` 中的 `time.sleep()` 参数

3. **备份数据**
   - 发送前备份 `捐赠证书/` 文件夹
   - 保存 `证书信息确认表.xlsx` 作为发送记录

### 隐私保护

- ⚠️ 证书文件可能包含个人信息，请妥善保管
- ⚠️ 不要将包含真实数据的文件夹上传到公共仓库
- ⚠️ 发送完成后，考虑删除或加密存储证书文件

---

## 🔄 与通用群发功能的区别

| 特性 | 证书群发 | 通用群发 |
|------|---------|---------|
| 收件人来源 | 从文件名提取 | 从 Excel 读取 |
| 附件 | 每人对应的证书 | 可自定义 |
| 邮件模板 | 固定感谢信模板 | 完全可自定义 |
| 使用场景 | 捐赠证书发送 | 任意邮件群发 |

---

## 📞 需要帮助？

- 环境配置问题：查看[根目录 README](../README.md)
- 邮箱配置问题：查看[根目录 README - 配置邮箱](../README.md#⚙️-配置邮箱)
- 通用问题：查看[根目录 README - 常见问题](../README.md#🔧-常见问题)

---

## 📄 许可证

本功能仅供内部使用，请确保：
- 已获得收件人同意发送邮件
- 证书内容真实有效
- 遵守相关法律法规
